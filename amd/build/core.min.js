define(["jquery","core/config","core/str","core/yui"],function($,mConfig,mString,Y){let session={courseModuleId:0,activityId:0,sessionId:0,attemptId:0,sessionKey:""},cache=[];class Ajax{static request(t,e,i,n){return i.id=session.courseModuleId,i.sessionid=session.sessionId,i.attemptid=session.attemptId,i.sesskey=session.sessionKey,$.ajax({type:t,url:e,data:i,dataType:"json",success:n,error:function(t,e,i){}})}static get(t,e,i){return e.action=t,Ajax.request("get","ajax.php",e,i)}static post(t,e,i){return e.action=t,Ajax.request("post","ajax.php",e,i)}}class Question{constructor(t){this.quiz=t,this.isRunning=!1,this.isLast=!1,this.isSaving=!1,this.endTime=0,this.isVoteRunning=!1,this.hasVotes=!1,this.countdownTimeLeft=0,this.questionType=void 0,this.questionTime=0,this.countdownInterval=0,this.timerInterval=0}static get box(){return $("#jazzquiz_question_box")}static get timer(){return $("#jazzquiz_question_timer")}static get form(){return $("#jazzquiz_question_form")}refresh(){let self=this;Ajax.get("get_question_form",{},function(data){self.questionType=data.question_type,data.is_already_submitted?setText(Quiz.info,"wait_for_instructor"):(Quiz.show(Question.box.html(data.html)),eval(data.js),data.use_mathex&&require(["filter_mathex/mathex"],function(t){t.input()}))}).fail(function(){setText(Quiz.info,"error_with_request")})}hideTimer(){Quiz.hide(Question.timer),clearInterval(this.timerInterval),this.timerInterval=0}onCountdownTick(t){this.countdownTimeLeft--,this.countdownTimeLeft<=0?(clearInterval(this.countdownInterval),this.countdownInterval=0,this.startAttempt(t)):0!==this.countdownTimeLeft?setText(Quiz.info,"question_will_start_in_x_seconds","jazzquiz",this.countdownTimeLeft):setText(Quiz.info,"question_will_start_now")}startCountdown(t,e){if(0!==this.countdownInterval)return!0;if(t=parseInt(t),e=parseInt(e),this.countdownTimeLeft=e,e<1)return!(t>0&&e<-t)&&(t>1?this.startAttempt(t+e):this.startAttempt(0),!0);let i=this;return this.countdownInterval=setInterval(function(){i.onCountdownTick(t)},1e3),!0}onTimerEnding(){this.isRunning=!1,this.quiz.role.onTimerEnding()}onTimerTick(){const t=(new Date).getTime();if(t>this.endTime)this.hideTimer(),this.onTimerEnding();else{const e=parseInt((this.endTime-t)/1e3);this.quiz.role.onTimerTick(e)}}startAttempt(t){if(Quiz.hide(Quiz.info),this.refresh(),this.isRunning=!0,0===(t=parseInt(t)))return;this.quiz.role.onTimerTick(t),this.endTime=(new Date).getTime()+1e3*t;let e=this;this.timerInterval=setInterval(function(){e.onTimerTick()},1e3)}static formattedBody(){if(!Question.box.length)return"Not found";let t=Question.box.clone();return t.find(".info").remove(),t.find(".im-controls").remove(),t.find(".questiontestslink").remove(),t.find("input").remove(),t.find("label").remove(),t.find(".ablock.form-inline").remove(),t.find(".save_row").remove(),t.html()}static isLoaded(){return""!==Question.box.html()}}class Quiz{constructor(t){this.state="",this.isNewState=!1,this.question=new Question(this),this.role=new t(this),this.events={notrunning:"onNotRunning",preparing:"onPreparing",running:"onRunning",reviewing:"onReviewing",sessionclosed:"onSessionClosed",voting:"onVoting"}}changeQuizState(t,e){this.isNewState=this.state!==t,this.state=t,this.role.onStateChange(t);const i=this.events[t];this.role[i](e)}poll(t){let e=this;Ajax.get("info",{},function(i){e.changeQuizState(i.status,i),setTimeout(e.poll.bind(e,t),t)})}static get main(){return $("#jazzquiz")}static get info(){return $("#jazzquiz_info_container")}static get responded(){return $("#jazzquiz_responded_container")}static get responses(){return $("#jazzquiz_responses_container")}static get responseInfo(){return $("#jazzquiz_response_info_container")}static hide(t){t.addClass("hidden")}static show(t){t.removeClass("hidden")}static renderAllMathjax(){Y.fire(M.core.event.FILTER_CONTENT_UPDATED,{nodes:new Y.NodeList(document.getElementsByClassName("jazzquiz-latex-wrapper"))})}static addMathjaxElement(t,e){$("#"+t).html('<span class="jazzquiz-latex-wrapper"><span class="filter_mathjaxloader_equation">'+e+"</span></span>"),Quiz.renderAllMathjax()}static renderMaximaEquation(t,e){null!==document.getElementById(e)&&(void 0===cache[t]?Ajax.get("stack",{input:encodeURIComponent(t)},function(t){cache[t.original]=t.latex,Quiz.addMathjaxElement(e,t.latex)}):Quiz.addMathjaxElement(e,cache[t]))}}function setText(t,e,i,n){i=void 0!==i?i:"jazzquiz",n=void 0!==n?n:[],$.when(mString.get_string(e,i,n)).done(function(e){t.html(e),Quiz.show(t)})}return{initialize:function(t,e,i,n,s){session.courseModuleId=t,session.activityId=e,session.sessionId=i,session.attemptId=n,session.sessionKey=s},Quiz:Quiz,Question:Question,Ajax:Ajax,setText:setText}});