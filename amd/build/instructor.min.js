define(["jquery","mod_jazzquiz/core"],function(e,t){const s=t.Quiz,n=t.Question,o=t.Ajax,r=t.setText;class i{constructor(t){this.quiz=t,this.currentResponses=[],this.showVotesUponReview=!1,this.respondedCount=0,this.showResponses=!1,this.totalStudents=0,e(document).on("click","#jazzquiz_undo_merge",this.undoMerge.bind(this));let s=this;e(document).on("click",function(e){e.target.classList.contains("bar")?s.startMerge(e.target.id):e.target.parentNode&&e.target.parentNode.classList.contains("bar")&&s.startMerge(e.target.parentNode.id)}),e(document).on("click","#review_show_normal_results",function(){s.refresh(!1)}),e(document).on("click","#review_show_vote_results",function(){s.refreshVotes()})}hide(){this.showResponses=!1,a.control("responses").children(".fa").removeClass("fa-check-square-o").addClass("fa-square-o"),s.hide(s.responses),s.hide(s.responseInfo)}show(){this.showResponses=!0,a.control("responses").children(".fa").removeClass("fa-square-o").addClass("fa-check-square-o"),s.show(s.responses),s.show(s.responseInfo),this.showVotesUponReview?(this.refreshVotes(),this.showVotesUponReview=!1):this.refresh(!1)}toggle(){this.showResponses?this.hide():this.show()}endMerge(){e(".merge-into").removeClass("merge-into"),e(".merge-from").removeClass("merge-from")}undoMerge(){o.post("undo_merge",{},this.refresh.bind(this,!0))}merge(e,t){o.post("merge_responses",{from:e,into:t},this.refresh.bind(this,!1))}startMerge(t){const s=e("#"+t);let n=s.parent();if(n.hasClass("merge-from"))this.endMerge();else{if(n.hasClass("merge-into")){const t=e(".merge-from");return this.merge(t.data("response"),n.data("response")),void this.endMerge()}n.addClass("merge-from"),n.parent().parent().find("tr").each(function(){e(this).find("td")[1].id!==s.attr("id")&&e(this).addClass("merge-into")})}}createControls(t){if(this.quiz.question.hasVotes){if("reviewing"===this.quiz.state){let n=e("#review_show_normal_results"),o=e("#review_show_vote_results");s.show(s.responseInfo),"vote_response"===t?0===n.length&&(r(s.responseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_vote_results"),s.responseInfo.append('<button id="review_show_normal_results" class="btn btn-primary"></button><br>'),r(e("#review_show_normal_results"),"click_to_show_original_results"),o.remove()):"current_response"===t&&0===o.length&&(r(s.responseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_original_results"),s.responseInfo.append('<button id="review_show_vote_results" class="btn btn-primary"></button><br>'),r(e("#review_show_vote_results"),"click_to_show_vote_results"),n.remove())}}else s.hide(s.responseInfo)}createBarGraph(t,n,o,r,i){let a=document.getElementById(o);if(null===a)return;let u=0;for(let e=0;e<t.length;e++)u+=parseInt(t[e].count);0===u&&(u=1),i&&(a.innerHTML="");for(let e=0;e<a.rows.length;e++){let s=!0;for(let n=0;n<t.length;n++)if(a.rows[e].dataset.response===t[n].response){s=!1;break}s&&(a.deleteRow(e),e--)}this.createControls(n),n+=r;for(let o=0;o<t.length;o++){const r=parseInt(t[o].count)/u*100;let i=-1,l=-1;for(let e=0;e<a.rows.length;e++)if(a.rows[e].dataset.response===t[o].response){i=a.rows[e].dataset.row_i,l=e;break}if(-1===i){i=a.rows.length;let u=a.insertRow();u.dataset.response_i=o,u.dataset.response=t[o].response,u.dataset.percent=r,u.dataset.row_i=i,u.dataset.count=t[o].count,u.classList.add("selected-vote-option");const l='<span id="'+n+"_count_"+i+'">'+t[o].count+"</span>";let c=u.insertCell(0);c.onclick=function(){e(this).parent().toggleClass("selected-vote-option")};let d=u.insertCell(1);d.classList.add("bar"),d.id=n+"_bar_"+i,d.innerHTML='<div style="width:'+r+'%;">'+l+"</div>";const h=n+"_latex_"+i;c.innerHTML='<span id="'+h+'"></span>',s.addMathjaxElement(h,t[o].response),"stack"===t[o].qtype&&s.renderMaximaEquation(t[o].response,h)}else{a.rows[l].dataset.row_i=i,a.rows[l].dataset.response_i=o,a.rows[l].dataset.percent=r,a.rows[l].dataset.count=t[o].count;let e=document.getElementById(n+"_count_"+i);null!==e&&(e.innerHTML=t[o].count);let s=document.getElementById(n+"_bar_"+i);null!==s&&(s.firstElementChild.style.width=r+"%")}}}static sortBarGraph(e){let t=document.getElementById(e);if(null===t)return;let s=!0;for(;s;){s=!1;for(let e=0;e<t.rows.length-1;e++){if(parseInt(t.rows[e].dataset.percent)<parseInt(t.rows[e+1].dataset.percent)){t.rows[e].parentNode.insertBefore(t.rows[e+1],t.rows[e]),s=!0;break}}}}set(t,n,o,a,u,l,c){if(void 0===o)return;if(0===o.length)return s.show(s.responded),void r(s.responded.find("h4"),"a_out_of_b_responded","jazzquiz",{a:0,b:this.totalStudents});switch(u){case"shortanswer":for(let e=0;e<o.length;e++)o[e].response=o[e].response.trim();break;case"stack":for(let e=0;e<o.length;e++)o[e].response=o[e].response.replace(/\s/g,"")}this.currentResponses=[],this.respondedCount=0;for(let e=0;e<o.length;e++){let t=!1,s=1;void 0!==o[e].count&&(s=parseInt(o[e].count)),this.respondedCount+=s;for(let n=0;n<this.currentResponses.length;n++)if(this.currentResponses[n].response===o[e].response){this.currentResponses[n].count+=s,t=!0;break}t||this.currentResponses.push({response:o[e].response,count:s,qtype:u})}if(0!==s.responded.length&&void 0!==a&&(s.show(s.responded),r(s.responded.find("h4"),"a_out_of_b_responded","jazzquiz",{a:a,b:this.totalStudents})),!this.showResponses&&"reviewing"!==this.quiz.state)return s.hide(s.responseInfo),void s.hide(s.responses);let d=document.getElementById(n);if(null===d){let o=e("#"+t);if(s.show(o),o.html('<table id="'+n+'" class="jazzquiz-responses-overview"></table>'),null===(d=document.getElementById(n)))return}this.createBarGraph(this.currentResponses,"current_response",n,l,c),i.sortBarGraph(n)}refresh(t){let n=this;o.get("get_results",{},function(o){n.quiz.question.hasVotes=o.has_votes,n.totalStudents=parseInt(o.total_students),n.set("jazzquiz_responses_container","current_responses_wrapper",o.responses,o.responded,o.question_type,"results",t),o.merge_count>0?s.show(e("#jazzquiz_undo_merge")):s.hide(e("#jazzquiz_undo_merge"))}).fail(function(){r(s.info,"error_getting_current_results")})}refreshVotes(){if(!this.showResponses&&"reviewing"!==this.quiz.state)return s.hide(s.responseInfo),void s.hide(s.responses);let e=this;o.get("get_vote_results",{},function(t){const n=t.answers,o="wrapper_vote_responses";let a=[];e.respondedCount=0,e.totalStudents=parseInt(t.total_students);for(let t in n)n.hasOwnProperty(t)&&(a.push({response:n[t].attempt,count:n[t].finalcount,qtype:n[t].qtype,slot:n[t].slot}),e.respondedCount+=parseInt(n[t].finalcount));r(s.responded.find("h4"),"a_out_of_b_voted","jazzquiz",{a:e.respondedCount,b:e.totalStudents});let u=document.getElementById(o);null===u&&(s.show(s.responses),s.responses.html('<table id="'+o+'" class="jazzquiz-responses-overview"></table>'),null===(u=document.getElementById(o)))||(e.createBarGraph(a,"vote_response",o,"vote",!1),i.sortBarGraph(o))}).fail(function(){r(s.info,"error_getting_vote_results")})}}class a{constructor(t){this.quiz=t,this.responses=new i(t),this.isShowingCorrectAnswer=!1,this.totalQuestions=0,e(document).on("keyup",function(e){27===e.keyCode&&a.closeFullscreenView()}),e(document).on("click",function(e){a.closeQuestionListMenu(e,"improvise"),a.closeQuestionListMenu(e,"jump")});let s=this;a.addEvents({repoll:function(){a.enableControls([]),s.repollQuestion()},vote:function(){a.enableControls([]),s.runVoting()},improvise:function(){s.showImproviseQuestionSetup()},jump:function(){s.showJumpQuestionSetup()},next:function(){a.enableControls([]),s.nextQuestion()},end:function(){a.enableControls([]),s.endQuestion()},fullscreen:function(){a.enableControls([]),a.showFullscreenView()},answer:function(){a.enableControls([]),s.showCorrectAnswer()},responses:function(){a.enableControls([]),s.responses.toggle()},exit:function(){a.enableControls([]),s.closeSession()},quit:function(){a.enableControls([]),s.closeSession()},startquiz:function(){a.enableControls([]),s.startQuiz()}})}static addEvents(t){for(let s in t)t.hasOwnProperty(s)&&e(document).on("click","#jazzquiz_control_"+s,t[s])}static get controls(){return e("#jazzquiz_controls_box")}static get controlButtons(){return a.controls.find(".quiz-control-buttons")}static control(t){return e("#jazzquiz_control_"+t)}static get side(){return e("#jazzquiz_side_container")}static get correctAnswer(){return e("#jazzquiz_correct_answer_container")}onNotRunning(e){this.responses.totalStudents=e.student_count,s.hide(a.side),r(s.info,"instructions_for_instructor"),a.enableControls([]),s.hide(a.controlButtons);let t=a.control("startquiz").next();1===e.student_count?r(t,"one_student_has_joined"):e.student_count>1?r(t,"x_students_have_joined","jazzquiz",e.student_count):r(t,"no_students_have_joined"),s.show(a.control("startquiz").parent())}onPreparing(e){s.hide(a.side),r(s.info,"instructions_for_instructor");let t=["improvise","jump","fullscreen","quit"];e.slot<this.totalQuestions&&t.push("next"),a.enableControls(t)}onRunning(t){if(s.show(a.side),a.enableControls(["end","responses","fullscreen"]),this.quiz.question.questionTime=t.questiontime,this.quiz.question.isRunning){t.questionTime>0&&t.delay<-t.questiontime&&this.endQuestion();const s=0!==e(".merge-from").length;this.responses.refresh(!s)}else{this.quiz.question.startCountdown(t.questiontime,t.delay)&&(this.quiz.question.isRunning=!0)}}onReviewing(e){s.show(a.side);let t=["answer","vote","repoll","fullscreen","improvise","jump","quit"];e.slot<this.totalQuestions&&t.push("next"),a.enableControls(t),n.isLoaded()||this.quiz.question.refresh(),this.quiz.isNewState&&this.responses.show(),this.quiz.question.isRunning=!1}onSessionClosed(e){s.hide(a.side),a.enableControls([]),this.quiz.question.isRunning=!1}onVoting(e){s.show(a.side),a.enableControls(["quit","fullscreen","answer","responses","end"]),this.responses.refreshVotes()}onStateChange(t){e("#region-main").find("ul.nav.nav-tabs").css("display","none"),e("#region-main-settings-menu").css("display","none"),e(".region_main_settings_menu_proxy").css("display","none"),s.show(a.controlButtons),s.hide(a.control("startquiz").parent())}onTimerEnding(){this.endQuestion()}onTimerTick(e){r(n.timer,"x_seconds_left","jazzquiz",e)}startQuiz(){s.hide(a.control("startquiz").parent()),o.post("start_quiz",{},function(){e("#jazzquiz_controls").removeClass("btn-hide")})}endQuestion(){this.quiz.question.hideTimer();let e=this;o.post("end_question",{},function(){"voting"===e.quiz.state?e.responses.showVotesUponReview=!0:(e.quiz.question.isRunning=!1,a.enableControls([]))}).fail(function(){r(s.info,"failed_to_end_question")})}showQuestionListSetup(t,s){let n=a.control(t);if(n.hasClass("active"))return;if("yes"===n.data("isclosed"))return void n.data("isclosed","");let r=this;o.get(s,{},function(s){let o=e("#jazzquiz_"+t+"_menu");const i=n.offset().left-n.parent().offset().left;o.html("").addClass("active").css("margin-left",i+"px"),n.addClass("active");const a=s.questions;for(let t in a){if(!a.hasOwnProperty(t))continue;let s=e('<button class="btn">'+a[t].name+"</button>");s.data({time:a[t].time,"question-id":a[t].questionid,"jazzquiz-question-id":a[t].jazzquizquestionid}),s.data("test",1),s.on("click",function(){const t=e(this).data("question-id"),s=e(this).data("time"),i=e(this).data("jazzquiz-question-id");r.jumpQuestion(t,s,i),o.html("").removeClass("active"),n.removeClass("active").data("isclosed","yes")}),o.append(s)}})}showImproviseQuestionSetup(){this.showQuestionListSetup("improvise","list_improvise_questions")}showJumpQuestionSetup(){this.showQuestionListSetup("jump","list_jump_questions")}static getSelectedAnswersForVote(){let t=[];return e(".selected-vote-option").each(function(e,s){t.push({text:s.dataset.response,count:s.dataset.count})}),t}runVoting(){const e=a.getSelectedAnswersForVote(),t=encodeURIComponent(JSON.stringify(e));o.post("run_voting",{questions:t},function(){}).fail(function(){r(s.info,"error_starting_vote")})}startQuestion(e,t,n,i){s.hide(s.info);let a=this;o.post("start_question",{method:e,questionid:t,questiontime:n,jazzquizquestionid:i},function(e){a.quiz.question.startCountdown(e.questiontime,e.delay)}).fail(function(){r(s.info,"error_with_request")})}jumpQuestion(e,t,s){this.startQuestion("jump",e,t,s)}repollQuestion(){this.startQuestion("repoll",0,0,0)}nextQuestion(){this.startQuestion("next",0,0,0)}closeSession(){s.hide(n.box),s.hide(a.controls),r(s.info,"closing_session"),o.post("close_session",{},function(){r(s.info,"session_closed")}).fail(function(){r(s.info,"error_with_request")})}showCorrectAnswer(){if(this.isShowingCorrectAnswer)return s.hide(a.correctAnswer),a.control("answer").children(".fa").removeClass("fa-check-square-o").addClass("fa-square-o"),void(this.isShowingCorrectAnswer=!1);let e=this;o.get("get_right_response",{},function(t){const n='<span class="jazzquiz-latex-wrapper">'+t.right_answer+"</span>";s.show(a.correctAnswer.html(n)),s.renderAllMathjax(),a.control("answer").children(".fa").removeClass("fa-square-o").addClass("fa-check-square-o"),e.isShowingCorrectAnswer=!0}).fail(function(){r(s.info,"error_with_request")})}static enableControls(e){let t=a.controlButtons.children("button");for(let s=0;s<t.length;s++){const n=t[s].getAttribute("id").replace("jazzquiz_control_","");t[s].disabled=-1===e.indexOf(n)}}static showFullscreenView(){s.main.hasClass("jazzquiz-fullscreen")?a.closeFullscreenView():(document.documentElement.style.overflowY="hidden",s.main.addClass("jazzquiz-fullscreen"))}static closeFullscreenView(){document.documentElement.style.overflowY="auto",s.main.removeClass("jazzquiz-fullscreen")}static closeQuestionListMenu(t,s){const n="#jazzquiz_"+s+"_menu";e(t.target).closest(n).length||(e(n).html("").removeClass("active"),a.control(s).removeClass("active"))}static addReportEventHandlers(){e(document).on("click","#report_overview_controls button",function(){const t=e(this).data("action");"attendance"===t?(e("#report_overview_responded").fadeIn(),e("#report_overview_responses").fadeOut()):"responses"===t&&(e("#report_overview_responses").fadeIn(),e("#report_overview_responded").fadeOut())})}}return{initialize:function(e,t,n){let o=new s(a);if(o.role.totalQuestions=e,t){a.addReportEventHandlers(),o.role.responses.showResponses=!0;for(let e of n){const t="jazzquiz_wrapper_responses_"+e.num,s="responses_wrapper_table_"+e.num,n="report_"+e.num;o.role.responses.set(t,s,e.responses,void 0,e.type,n,!1)}}else o.poll(500)}}});