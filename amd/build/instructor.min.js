define(["jquery","mod_jazzquiz/core"],function(e,s){const t=s.Quiz,o=s.Question,n=s.Ajax,r=s.setText;class i{constructor(s){this.quiz=s,this.currentResponses=[],this.showVotesUponReview=!1,this.respondedCount=0,this.showResponses=!1,this.totalStudents=0,e(document).on("click","#jazzquiz_undo_merge",()=>this.undoMerge()),e(document).on("click",e=>{e.target.classList.contains("bar")?this.startMerge(e.target.id):e.target.parentNode&&e.target.parentNode.classList.contains("bar")&&this.startMerge(e.target.parentNode.id)}),e(document).on("click","#review_show_normal_results",()=>this.refresh(!1)),e(document).on("click","#review_show_vote_results",()=>this.refreshVotes())}clear(){t.responses.html(""),t.responseInfo.html("")}hide(){t.uncheck(a.control("responses")),t.hide(t.responses),t.hide(t.responseInfo)}show(){t.check(a.control("responses")),t.show(t.responses),t.show(t.responseInfo),this.showVotesUponReview?(this.refreshVotes(),this.showVotesUponReview=!1):this.refresh(!1)}toggle(){this.showResponses=!this.showResponses,this.showResponses?this.show():this.hide()}endMerge(){e(".merge-into").removeClass("merge-into"),e(".merge-from").removeClass("merge-from")}undoMerge(){n.post("undo_merge",{},()=>this.refresh(!0))}merge(e,s){n.post("merge_responses",{from:e,into:s},()=>this.refresh(!1))}startMerge(s){const t=e("#"+s);let o=t.parent();if(o.hasClass("merge-from"))this.endMerge();else{if(o.hasClass("merge-into")){const s=e(".merge-from");return this.merge(s.data("response"),o.data("response")),void this.endMerge()}o.addClass("merge-from"),o.parent().parent().find("tr").each(function(){e(this).find("td")[1].id!==t.attr("id")&&e(this).addClass("merge-into")})}}createControls(s){if(this.quiz.question.hasVotes){if("reviewing"===this.quiz.state){let o=e("#review_show_normal_results"),n=e("#review_show_vote_results");t.show(t.responseInfo),"vote_response"===s?0===o.length&&(r(t.responseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_vote_results"),t.responseInfo.append('<button id="review_show_normal_results" class="btn btn-primary"></button><br>'),r(e("#review_show_normal_results"),"click_to_show_original_results"),n.remove()):"current_response"===s&&0===n.length&&(r(t.responseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_original_results"),t.responseInfo.append('<button id="review_show_vote_results" class="btn btn-primary"></button><br>'),r(e("#review_show_vote_results"),"click_to_show_vote_results"),o.remove())}}else t.hide(t.responseInfo)}createBarGraph(s,o,n,r,i){let a=document.getElementById(n);if(null===a)return;let l=0;for(let e=0;e<s.length;e++)l+=parseInt(s[e].count);0===l&&(l=1),i&&(a.innerHTML="");for(let e=0;e<a.rows.length;e++){let t=!0;for(let o=0;o<s.length;o++)if(a.rows[e].dataset.response===s[o].response){t=!1;break}t&&(a.deleteRow(e),e--)}this.createControls(o),o+=r;for(let n=0;n<s.length;n++){const r=parseInt(s[n].count)/l*100;let i=-1,u=-1;for(let e=0;e<a.rows.length;e++)if(a.rows[e].dataset.response===s[n].response){i=a.rows[e].dataset.row_i,u=e;break}if(-1===i){i=a.rows.length;let l=a.insertRow();l.dataset.response_i=n,l.dataset.response=s[n].response,l.dataset.percent=r,l.dataset.row_i=i,l.dataset.count=s[n].count,l.classList.add("selected-vote-option");const u='<span id="'+o+"_count_"+i+'">'+s[n].count+"</span>";let h=l.insertCell(0);h.onclick=function(){e(this).parent().toggleClass("selected-vote-option")};let d=l.insertCell(1);d.classList.add("bar"),d.id=o+"_bar_"+i,d.innerHTML='<div style="width:'+r+'%;">'+u+"</div>";const c=o+"_latex_"+i;h.innerHTML='<span id="'+c+'"></span>',t.addMathjaxElement(e("#"+c),s[n].response),"stack"===s[n].qtype&&t.renderMaximaEquation(s[n].response,c)}else{a.rows[u].dataset.row_i=i,a.rows[u].dataset.response_i=n,a.rows[u].dataset.percent=r,a.rows[u].dataset.count=s[n].count;let e=document.getElementById(o+"_count_"+i);null!==e&&(e.innerHTML=s[n].count);let t=document.getElementById(o+"_bar_"+i);null!==t&&(t.firstElementChild.style.width=r+"%")}}}static sortBarGraph(e){let s=document.getElementById(e);if(null===s)return;let t=!0;for(;t;){t=!1;for(let e=0;e<s.rows.length-1;e++){if(parseInt(s.rows[e].dataset.percent)<parseInt(s.rows[e+1].dataset.percent)){s.rows[e].parentNode.insertBefore(s.rows[e+1],s.rows[e]),t=!0;break}}}}set(s,o,n,a,l,u,h){if(void 0!==n){if(0===n.length)return t.show(t.responded),void r(t.responded.find("h4"),"a_out_of_b_responded","jazzquiz",{a:0,b:this.totalStudents});switch(l){case"shortanswer":for(let e=0;e<n.length;e++)n[e].response=n[e].response.trim();break;case"stack":for(let e=0;e<n.length;e++)n[e].response=n[e].response.replace(/\s/g,"")}this.currentResponses=[],this.respondedCount=0;for(let e=0;e<n.length;e++){let s=!1,t=1;void 0!==n[e].count&&(t=parseInt(n[e].count)),this.respondedCount+=t;for(let o=0;o<this.currentResponses.length;o++)if(this.currentResponses[o].response===n[e].response){this.currentResponses[o].count+=t,s=!0;break}s||this.currentResponses.push({response:n[e].response,count:t,qtype:l})}if(0!==t.responded.length&&void 0!==a&&(t.show(t.responded),r(t.responded.find("h4"),"a_out_of_b_responded","jazzquiz",{a:a,b:this.totalStudents})),!this.showResponses&&"reviewing"!==this.quiz.state)return t.hide(t.responseInfo),void t.hide(t.responses);if(null===document.getElementById(o)){const n='<table id="'+o+'" class="jazzquiz-responses-overview"></table>';t.show(e("#"+s).html(n))}this.createBarGraph(this.currentResponses,"current_response",o,u,h),i.sortBarGraph(o)}}refresh(s){n.get("get_results",{},o=>{this.quiz.question.hasVotes=o.has_votes,this.totalStudents=parseInt(o.total_students),this.set("jazzquiz_responses_container","current_responses_wrapper",o.responses,o.responded,o.question_type,"results",s),o.merge_count>0?t.show(e("#jazzquiz_undo_merge")):t.hide(e("#jazzquiz_undo_merge"))})}refreshVotes(){if(!this.showResponses&&"reviewing"!==this.quiz.state)return t.hide(t.responseInfo),void t.hide(t.responses);n.get("get_vote_results",{},e=>{const s=e.answers,o="wrapper_vote_responses";let n=[];this.respondedCount=0,this.totalStudents=parseInt(e.total_students);for(let e in s)s.hasOwnProperty(e)&&(n.push({response:s[e].attempt,count:s[e].finalcount,qtype:s[e].qtype,slot:s[e].slot}),this.respondedCount+=parseInt(s[e].finalcount));if(r(t.responded.find("h4"),"a_out_of_b_voted","jazzquiz",{a:this.respondedCount,b:this.totalStudents}),null===document.getElementById(o)){const e='<table id="'+o+'" class="jazzquiz-responses-overview"></table>';t.show(t.responses.html(e))}this.createBarGraph(n,"vote_response",o,"vote",!1),i.sortBarGraph(o)})}}class a{constructor(s){this.quiz=s,this.responses=new i(s),this.isShowingCorrectAnswer=!1,this.totalQuestions=0,this.allowVote=!1,e(document).on("keyup",e=>{27===e.keyCode&&a.closeFullscreenView()}),e(document).on("click",e=>{a.closeQuestionListMenu(e,"improvise"),a.closeQuestionListMenu(e,"jump")}),a.addEvents({repoll:()=>this.repollQuestion(),vote:()=>this.runVoting(),improvise:()=>this.showQuestionListSetup("improvise"),jump:()=>this.showQuestionListSetup("jump"),next:()=>this.nextQuestion(),end:()=>this.endQuestion(),fullscreen:()=>a.showFullscreenView(),answer:()=>this.showCorrectAnswer(),responses:()=>this.responses.toggle(),exit:()=>this.closeSession(),quit:()=>this.closeSession(),startquiz:()=>this.startQuiz()}),a.addHotkeys({t:"responses",r:"repoll",a:"answer",e:"end",j:"jump",i:"improvise",v:"vote",n:"next",f:"fullscreen"})}static addHotkeys(s){for(let t in s)s.hasOwnProperty(t)&&(s[t]={action:s[t],repeat:!1},e(document).on("keydown",o=>{if(s[t].repeat||o.ctrlKey)return;if(String.fromCharCode(o.which).toLowerCase()!==t)return;let n=e(":focus").prop("tagName");if(void 0!==n&&("input"===(n=n.toLowerCase())||"textarea"===n))return;o.preventDefault(),s[t].repeat=!0;let r=a.control(s[t].action);r.length&&!r.prop("disabled")&&r.click()}),e(document).on("keyup",e=>{String.fromCharCode(e.which).toLowerCase()===t&&(s[t].repeat=!1)}))}static addEvents(s){for(let t in s)s.hasOwnProperty(t)&&e(document).on("click","#jazzquiz_control_"+t,()=>{a.enableControls([]),s[t]()})}static get controls(){return e("#jazzquiz_controls_box")}static get controlButtons(){return a.controls.find(".quiz-control-buttons")}static control(s){return e("#jazzquiz_control_"+s)}static get side(){return e("#jazzquiz_side_container")}static get correctAnswer(){return e("#jazzquiz_correct_answer_container")}static get isMerging(){return 0!==e(".merge-from").length}onNotRunning(e){this.responses.totalStudents=e.student_count,t.hide(a.side),r(t.info,"instructions_for_instructor"),a.enableControls([]),t.hide(a.controlButtons);let s=a.control("startquiz").next();1===e.student_count?r(s,"one_student_has_joined"):e.student_count>1?r(s,"x_students_have_joined","jazzquiz",e.student_count):r(s,"no_students_have_joined"),t.show(a.control("startquiz").parent())}onPreparing(e){t.hide(a.side),r(t.info,"instructions_for_instructor");let s=["improvise","jump","fullscreen","quit"];e.slot<this.totalQuestions&&s.push("next"),a.enableControls(s)}onRunning(e){if(this.responses.showResponses||this.responses.hide(),t.show(a.side),a.enableControls(["end","responses","fullscreen"]),this.quiz.question.questionTime=e.questiontime,this.quiz.question.isRunning)e.questionTime>0&&e.delay<-e.questiontime&&this.endQuestion(),this.responses.refresh(!a.isMerging);else{this.quiz.question.startCountdown(e.questiontime,e.delay)&&(this.quiz.question.isRunning=!0)}}onReviewing(e){t.show(a.side);let s=["answer","repoll","fullscreen","improvise","jump","quit"];this.allowVote&&s.push("vote"),e.slot<this.totalQuestions&&s.push("next"),a.enableControls(s),o.isLoaded()||this.quiz.question.refresh(),this.quiz.isNewState&&this.responses.show(),this.quiz.question.isRunning=!1}onSessionClosed(e){t.hide(a.side),t.hide(a.correctAnswer),a.enableControls([]),this.responses.clear(),this.quiz.question.isRunning=!1}onVoting(e){this.responses.showResponses||this.responses.hide(),t.show(a.side),a.enableControls(["quit","fullscreen","answer","responses","end"]),this.responses.refreshVotes()}onStateChange(s){e("#region-main").find("ul.nav.nav-tabs").css("display","none"),e("#region-main-settings-menu").css("display","none"),e(".region_main_settings_menu_proxy").css("display","none"),t.show(a.controlButtons),t.hide(a.control("startquiz").parent())}onQuestionRefreshed(e){this.allowVote=e.voteable}onTimerEnding(){this.endQuestion()}onTimerTick(e){r(o.timer,"x_seconds_left","jazzquiz",e)}startQuiz(){t.hide(a.control("startquiz").parent()),n.post("start_quiz",{},()=>e("#jazzquiz_controls").removeClass("btn-hide"))}endQuestion(){this.quiz.question.hideTimer(),n.post("end_question",{},()=>{"voting"===this.quiz.state?this.responses.showVotesUponReview=!0:(this.quiz.question.isRunning=!1,a.enableControls([]))})}showQuestionListSetup(s){let o=a.control(s);o.hasClass("active")||("yes"!==o.data("isclosed")?n.get("list_"+s+"_questions",{},n=>{let r=this,i=e("#jazzquiz_"+s+"_menu");const a=o.offset().left-o.parent().offset().left;i.html("").addClass("active").css("margin-left",a+"px"),o.addClass("active");const l=n.questions;for(let s in l){if(!l.hasOwnProperty(s))continue;let n=e('<button class="btn"></button>');t.addMathjaxElement(n,l[s].name),n.data({time:l[s].time,"question-id":l[s].questionid,"jazzquiz-question-id":l[s].jazzquizquestionid}),n.data("test",1),n.on("click",function(){const s=e(this).data("question-id"),t=e(this).data("time"),n=e(this).data("jazzquiz-question-id");r.jumpQuestion(s,t,n),i.html("").removeClass("active"),o.removeClass("active").data("isclosed","yes")}),i.append(n)}}):o.data("isclosed",""))}static getSelectedAnswersForVote(){let s=[];return e(".selected-vote-option").each((e,t)=>{s.push({text:t.dataset.response,count:t.dataset.count})}),s}runVoting(){const e=a.getSelectedAnswersForVote(),s={questions:encodeURIComponent(JSON.stringify(e))};n.post("run_voting",s,()=>{})}startQuestion(e,s,o,r){t.hide(t.info),this.responses.clear(),n.post("start_question",{method:e,questionid:s,questiontime:o,jazzquizquestionid:r},e=>this.quiz.question.startCountdown(e.questiontime,e.delay))}jumpQuestion(e,s,t){this.startQuestion("jump",e,s,t)}repollQuestion(){this.startQuestion("repoll",0,0,0)}nextQuestion(){this.startQuestion("next",0,0,0)}closeSession(){t.hide(e("#jazzquiz_undo_merge")),t.hide(o.box),t.hide(a.controls),r(t.info,"closing_session"),n.post("close_session",{},()=>r(t.info,"session_closed"))}showCorrectAnswer(){if(this.isShowingCorrectAnswer)return t.hide(a.correctAnswer),t.uncheck(a.control("answer")),void(this.isShowingCorrectAnswer=!1);n.get("get_right_response",{},e=>{const s='<span class="jazzquiz-latex-wrapper">'+e.right_answer+"</span>";t.show(a.correctAnswer.html(s)),t.renderAllMathjax(),t.check(a.control("answer")),this.isShowingCorrectAnswer=!0})}static enableControls(e){let s=a.controlButtons.children("button");for(let t of s){const s=t.getAttribute("id").replace("jazzquiz_control_","");t.disabled=-1===e.indexOf(s)}}static showFullscreenView(){t.main.hasClass("jazzquiz-fullscreen")?a.closeFullscreenView():(document.documentElement.style.overflowY="hidden",t.main.addClass("jazzquiz-fullscreen"))}static closeFullscreenView(){document.documentElement.style.overflowY="auto",t.main.removeClass("jazzquiz-fullscreen")}static closeQuestionListMenu(s,t){const o="#jazzquiz_"+t+"_menu";e(s.target).closest(o).length||(e(o).html("").removeClass("active"),a.control(t).removeClass("active"))}static addReportEventHandlers(){e(document).on("click","#report_overview_controls button",function(){const s=e(this).data("action");"attendance"===s?(e("#report_overview_responded").fadeIn(),e("#report_overview_responses").fadeOut()):"responses"===s&&(e("#report_overview_responses").fadeIn(),e("#report_overview_responded").fadeOut())})}}return{initialize:function(e,s,o){let n=new t(a);if(n.role.totalQuestions=e,s){a.addReportEventHandlers(),n.role.responses.showResponses=!0;for(let e of o){const s="jazzquiz_wrapper_responses_"+e.num,t="responses_wrapper_table_"+e.num,o="report_"+e.num;n.role.responses.set(s,t,e.responses,void 0,e.type,o,!1)}}else n.poll(500)}}});