"use strict";var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,s,n){return s&&e(t.prototype,s),n&&e(t,n),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}define(["jquery","mod_jazzquiz/core"],function(e,t){var s=t.Quiz,n=t.Question,o=t.Ajax,r=t.setText,i=function(){function t(s){var n=this;_classCallCheck(this,t),this.quiz=s,this.currentResponses=[],this.showVotesUponReview=!1,this.respondedCount=0,this.showResponses=!1,this.totalStudents=0,e(document).on("click","#jazzquiz_undo_merge",function(){return n.undoMerge()}),e(document).on("click",function(e){e.target.classList.contains("bar")?n.startMerge(e.target.id):e.target.parentNode&&e.target.parentNode.classList.contains("bar")&&n.startMerge(e.target.parentNode.id)}),e(document).on("click","#review_show_normal_results",function(){return n.refresh(!1)}),e(document).on("click","#review_show_vote_results",function(){return n.refreshVotes()})}return _createClass(t,[{key:"clear",value:function(){s.responses.html(""),s.responseInfo.html("")}},{key:"hide",value:function(){s.uncheck(a.control("responses")),s.hide(s.responses),s.hide(s.responseInfo)}},{key:"show",value:function(){s.check(a.control("responses")),s.show(s.responses),s.show(s.responseInfo),this.showVotesUponReview?(this.refreshVotes(),this.showVotesUponReview=!1):this.refresh(!1)}},{key:"toggle",value:function(){this.showResponses=!this.showResponses,this.showResponses?this.show():this.hide()}},{key:"endMerge",value:function(){e(".merge-into").removeClass("merge-into"),e(".merge-from").removeClass("merge-from")}},{key:"undoMerge",value:function(){var e=this;o.post("undo_merge",{},function(){return e.refresh(!0)})}},{key:"merge",value:function(e,t){var s=this;o.post("merge_responses",{from:e,into:t},function(){return s.refresh(!1)})}},{key:"startMerge",value:function(t){var s=e("#"+t),n=s.parent();if(n.hasClass("merge-from"))this.endMerge();else{if(n.hasClass("merge-into")){var o=e(".merge-from");return this.merge(o.data("response"),n.data("response")),void this.endMerge()}n.addClass("merge-from"),n.parent().parent().find("tr").each(function(){e(this).find("td")[1].id!==s.attr("id")&&e(this).addClass("merge-into")})}}},{key:"createControls",value:function(t){if(this.quiz.question.hasVotes){if("reviewing"===this.quiz.state){var n=e("#review_show_normal_results"),o=e("#review_show_vote_results");s.show(s.responseInfo),"vote_response"===t?0===n.length&&(r(s.responseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_vote_results"),s.responseInfo.append('<button id="review_show_normal_results" class="btn btn-primary"></button><br>'),r(e("#review_show_normal_results"),"click_to_show_original_results"),o.remove()):"current_response"===t&&0===o.length&&(r(s.responseInfo.html('<h4 class="inline"></h4>').children("h4"),"showing_original_results"),s.responseInfo.append('<button id="review_show_vote_results" class="btn btn-primary"></button><br>'),r(e("#review_show_vote_results"),"click_to_show_vote_results"),n.remove())}}else s.hide(s.responseInfo)}},{key:"createBarGraph",value:function(t,n,o,r,i){var a=document.getElementById(o);if(null!==a){for(var u=0,l=0,c=0;c<t.length;c++){var d=parseInt(t[c].count);u+=d,d>l&&(l=d)}0===u&&(u=1),i&&(a.innerHTML="");for(var h=0;h<a.rows.length;h++){for(var p=!0,f=0;f<t.length;f++)if(a.rows[h].dataset.response===t[f].response){p=!1;break}p&&(a.deleteRow(h),h--)}this.createControls(n),n+=r;for(var v=0;v<t.length;v++){for(var _=parseInt(t[v].count)/l*100,w=-1,m=-1,g=0;g<a.rows.length;g++)if(a.rows[g].dataset.response===t[v].response){w=a.rows[g].dataset.row_i,m=g;break}if(-1===w){w=a.rows.length;var z=a.insertRow();z.dataset.response_i=v,z.dataset.response=t[v].response,z.dataset.percent=_,z.dataset.row_i=w,z.dataset.count=t[v].count,z.classList.add("selected-vote-option"),_<15&&z.classList.add("outside");var y='<span id="'+n+"_count_"+w+'">'+t[v].count+"</span>",q=z.insertCell(0);q.onclick=function(){e(this).parent().toggleClass("selected-vote-option")};var k=z.insertCell(1);k.classList.add("bar"),k.id=n+"_bar_"+w,k.innerHTML='<div style="width:'+_+'%;">'+y+"</div>";var C=n+"_latex_"+w;q.innerHTML='<span id="'+C+'"></span>',s.addMathjaxElement(e("#"+C),t[v].response),"stack"===t[v].qtype&&s.renderMaximaEquation(t[v].response,C)}else{var b=a.rows[m];b.dataset.row_i=w,b.dataset.response_i=v,b.dataset.percent=_,b.dataset.count=t[v].count;var j=b.classList.contains("outside");_>15&&j?b.classList.remove("outside"):_<15&&!j&&b.classList.add("outside");var R=document.getElementById(n+"_count_"+w);null!==R&&(R.innerHTML=t[v].count);var Q=document.getElementById(n+"_bar_"+w);null!==Q&&(Q.firstElementChild.style.width=_+"%")}}}}},{key:"set",value:function(n,o,i,a,u,l,c){if(void 0!==i){if(0===i.length)return s.show(s.responded),void r(s.responded.find("h4"),"a_out_of_b_responded","jazzquiz",{a:0,b:this.totalStudents});switch(u){case"shortanswer":for(var d=0;d<i.length;d++)i[d].response=i[d].response.trim();break;case"stack":for(var h=0;h<i.length;h++)i[h].response=i[h].response.replace(/\s/g,"")}this.currentResponses=[],this.respondedCount=0;for(var p=0;p<i.length;p++){var f=!1,v=1;void 0!==i[p].count&&(v=parseInt(i[p].count)),this.respondedCount+=v;for(var _=0;_<this.currentResponses.length;_++)if(this.currentResponses[_].response===i[p].response){this.currentResponses[_].count+=v,f=!0;break}f||this.currentResponses.push({response:i[p].response,count:v,qtype:u})}if(0!==s.responded.length&&void 0!==a&&(s.show(s.responded),r(s.responded.find("h4"),"a_out_of_b_responded","jazzquiz",{a:a,b:this.totalStudents})),!this.showResponses&&"reviewing"!==this.quiz.state)return s.hide(s.responseInfo),void s.hide(s.responses);if(null===document.getElementById(o)){var w='<table id="'+o+'" class="jazzquiz-responses-overview"></table>';s.show(e("#"+n).html(w))}this.createBarGraph(this.currentResponses,"current_response",o,l,c),t.sortBarGraph(o)}}},{key:"refresh",value:function(t){var n=this;o.get("get_results",{},function(o){n.quiz.question.hasVotes=o.has_votes,n.totalStudents=parseInt(o.total_students),n.set("jazzquiz_responses_container","current_responses_wrapper",o.responses,o.responded,o.question_type,"results",t),o.merge_count>0?s.show(e("#jazzquiz_undo_merge")):s.hide(e("#jazzquiz_undo_merge"))})}},{key:"refreshVotes",value:function(){var e=this;if(!this.showResponses&&"reviewing"!==this.quiz.state)return s.hide(s.responseInfo),void s.hide(s.responses);o.get("get_vote_results",{},function(n){var o=n.answers,i="wrapper_vote_responses",a=[];for(var u in e.respondedCount=0,e.totalStudents=parseInt(n.total_students),o)o.hasOwnProperty(u)&&(a.push({response:o[u].attempt,count:o[u].finalcount,qtype:o[u].qtype,slot:o[u].slot}),e.respondedCount+=parseInt(o[u].finalcount));if(r(s.responded.find("h4"),"a_out_of_b_voted","jazzquiz",{a:e.respondedCount,b:e.totalStudents}),null===document.getElementById(i)){s.show(s.responses.html('<table id="wrapper_vote_responses" class="jazzquiz-responses-overview"></table>'))}e.createBarGraph(a,"vote_response",i,"vote",!1),t.sortBarGraph(i)})}}],[{key:"sortBarGraph",value:function(e){var t=document.getElementById(e);if(null!==t)for(var s=!0;s;){s=!1;for(var n=0;n<t.rows.length-1;n++){if(parseInt(t.rows[n].dataset.percent)<parseInt(t.rows[n+1].dataset.percent)){t.rows[n].parentNode.insertBefore(t.rows[n+1],t.rows[n]),s=!0;break}}}}}]),t}(),a=function(){function t(s){var n=this;_classCallCheck(this,t),this.quiz=s,this.responses=new i(s),this.isShowingCorrectAnswer=!1,this.totalQuestions=0,this.allowVote=!1,e(document).on("keyup",function(e){27===e.keyCode&&t.closeFullscreenView()}),e(document).on("click",function(e){t.closeQuestionListMenu(e,"improvise"),t.closeQuestionListMenu(e,"jump")}),t.addEvents({repoll:function(){return n.repollQuestion()},vote:function(){return n.runVoting()},improvise:function(){return n.showQuestionListSetup("improvise")},jump:function(){return n.showQuestionListSetup("jump")},next:function(){return n.nextQuestion()},end:function(){return n.endQuestion()},fullscreen:function(){return t.showFullscreenView()},answer:function(){return n.showCorrectAnswer()},responses:function(){return n.responses.toggle()},exit:function(){return n.closeSession()},quit:function(){return n.closeSession()},startquiz:function(){return n.startQuiz()}}),t.addHotkeys({t:"responses",r:"repoll",a:"answer",e:"end",j:"jump",i:"improvise",v:"vote",n:"next",f:"fullscreen"})}return _createClass(t,[{key:"onNotRunning",value:function(e){this.responses.totalStudents=e.student_count,s.hide(t.side),r(s.info,"instructions_for_instructor"),t.enableControls([]),s.hide(t.controlButtons);var n=t.control("startquiz").next();1===e.student_count?r(n,"one_student_has_joined"):e.student_count>1?r(n,"x_students_have_joined","jazzquiz",e.student_count):r(n,"no_students_have_joined"),s.show(t.control("startquiz").parent())}},{key:"onPreparing",value:function(e){s.hide(t.side),r(s.info,"instructions_for_instructor");var n=["improvise","jump","fullscreen","quit"];e.slot<this.totalQuestions&&n.push("next"),t.enableControls(n)}},{key:"onRunning",value:function(e){(this.responses.showResponses||this.responses.hide(),s.show(t.side),t.enableControls(["end","responses","fullscreen"]),this.quiz.question.questionTime=e.questiontime,this.quiz.question.isRunning)?(e.questionTime>0&&e.delay<-e.questiontime&&this.endQuestion(),this.responses.refresh(!t.isMerging)):this.quiz.question.startCountdown(e.questiontime,e.delay)&&(this.quiz.question.isRunning=!0)}},{key:"onReviewing",value:function(e){s.show(t.side);var o=["answer","repoll","fullscreen","improvise","jump","quit"];this.allowVote&&o.push("vote"),e.slot<this.totalQuestions&&o.push("next"),t.enableControls(o),n.isLoaded()||this.quiz.question.refresh(),this.quiz.isNewState&&this.responses.show(),this.quiz.question.isRunning=!1}},{key:"onSessionClosed",value:function(e){s.hide(t.side),s.hide(t.correctAnswer),t.enableControls([]),this.responses.clear(),this.quiz.question.isRunning=!1}},{key:"onVoting",value:function(e){this.responses.showResponses||this.responses.hide(),s.show(t.side),t.enableControls(["quit","fullscreen","answer","responses","end"]),this.responses.refreshVotes()}},{key:"onStateChange",value:function(n){e("#region-main").find("ul.nav.nav-tabs").css("display","none"),e("#region-main-settings-menu").css("display","none"),e(".region_main_settings_menu_proxy").css("display","none"),s.show(t.controlButtons),s.hide(t.control("startquiz").parent())}},{key:"onQuestionRefreshed",value:function(e){this.allowVote=e.voteable}},{key:"onTimerEnding",value:function(){this.endQuestion()}},{key:"onTimerTick",value:function(e){r(n.timer,"x_seconds_left","jazzquiz",e)}},{key:"startQuiz",value:function(){s.hide(t.control("startquiz").parent()),o.post("start_quiz",{},function(){return e("#jazzquiz_controls").removeClass("btn-hide")})}},{key:"endQuestion",value:function(){var e=this;this.quiz.question.hideTimer(),o.post("end_question",{},function(){"voting"===e.quiz.state?e.responses.showVotesUponReview=!0:(e.quiz.question.isRunning=!1,t.enableControls([]))})}},{key:"showQuestionListSetup",value:function(n){var r=this,i=t.control(n);i.hasClass("active")||("yes"!==i.data("isclosed")?o.get("list_"+n+"_questions",{},function(t){var o=r,a=e("#jazzquiz_"+n+"_menu"),u=i.offset().left-i.parent().offset().left;a.html("").addClass("active").css("margin-left",u+"px"),i.addClass("active");var l=t.questions;for(var c in l)if(l.hasOwnProperty(c)){var d=e('<button class="btn"></button>');s.addMathjaxElement(d,l[c].name),d.data({time:l[c].time,"question-id":l[c].questionid,"jazzquiz-question-id":l[c].jazzquizquestionid}),d.data("test",1),d.on("click",function(){var t=e(this).data("question-id"),s=e(this).data("time"),n=e(this).data("jazzquiz-question-id");o.jumpQuestion(t,s,n),a.html("").removeClass("active"),i.removeClass("active").data("isclosed","yes")}),a.append(d)}}):i.data("isclosed",""))}},{key:"runVoting",value:function(){var e=t.getSelectedAnswersForVote(),s={questions:encodeURIComponent(JSON.stringify(e))};o.post("run_voting",s,function(){})}},{key:"startQuestion",value:function(e,t,n,r){var i=this;s.hide(s.info),this.responses.clear(),o.post("start_question",{method:e,questionid:t,questiontime:n,jazzquizquestionid:r},function(e){return i.quiz.question.startCountdown(e.questiontime,e.delay)})}},{key:"jumpQuestion",value:function(e,t,s){this.startQuestion("jump",e,t,s)}},{key:"repollQuestion",value:function(){this.startQuestion("repoll",0,0,0)}},{key:"nextQuestion",value:function(){this.startQuestion("next",0,0,0)}},{key:"closeSession",value:function(){s.hide(e("#jazzquiz_undo_merge")),s.hide(n.box),s.hide(t.controls),r(s.info,"closing_session"),o.post("close_session",{},function(){return r(s.info,"session_closed")})}},{key:"showCorrectAnswer",value:function(){var e=this;if(this.isShowingCorrectAnswer)return s.hide(t.correctAnswer),s.uncheck(t.control("answer")),void(this.isShowingCorrectAnswer=!1);o.get("get_right_response",{},function(n){var o='<span class="jazzquiz-latex-wrapper">'+n.right_answer+"</span>";s.show(t.correctAnswer.html(o)),s.renderAllMathjax(),s.check(t.control("answer")),e.isShowingCorrectAnswer=!0})}}],[{key:"addHotkeys",value:function(s){var n=function(n){s.hasOwnProperty(n)&&(s[n]={action:s[n],repeat:!1},e(document).on("keydown",function(o){if(!s[n].repeat&&!o.ctrlKey&&String.fromCharCode(o.which).toLowerCase()===n){var r=e(":focus").prop("tagName");if(void 0===r||"input"!==(r=r.toLowerCase())&&"textarea"!==r){o.preventDefault(),s[n].repeat=!0;var i=t.control(s[n].action);i.length&&!i.prop("disabled")&&i.click()}}}),e(document).on("keyup",function(e){String.fromCharCode(e.which).toLowerCase()===n&&(s[n].repeat=!1)}))};for(var o in s)n(o)}},{key:"addEvents",value:function(s){var n=function(n){s.hasOwnProperty(n)&&e(document).on("click","#jazzquiz_control_"+n,function(){t.enableControls([]),s[n]()})};for(var o in s)n(o)}},{key:"control",value:function(t){return e("#jazzquiz_control_"+t)}},{key:"getSelectedAnswersForVote",value:function(){var t=[];return e(".selected-vote-option").each(function(e,s){t.push({text:s.dataset.response,count:s.dataset.count})}),t}},{key:"enableControls",value:function(e){var s=t.controlButtons.children("button"),n=!0,o=!1,r=void 0;try{for(var i,a=s[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){var u=i.value,l=u.getAttribute("id").replace("jazzquiz_control_","");u.disabled=-1===e.indexOf(l)}}catch(e){o=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(o)throw r}}}},{key:"showFullscreenView",value:function(){s.main.hasClass("jazzquiz-fullscreen")?t.closeFullscreenView():(document.documentElement.style.overflowY="hidden",s.main.addClass("jazzquiz-fullscreen"))}},{key:"closeFullscreenView",value:function(){document.documentElement.style.overflowY="auto",s.main.removeClass("jazzquiz-fullscreen")}},{key:"closeQuestionListMenu",value:function(s,n){var o="#jazzquiz_"+n+"_menu";e(s.target).closest(o).length||(e(o).html("").removeClass("active"),t.control(n).removeClass("active"))}},{key:"addReportEventHandlers",value:function(){e(document).on("click","#report_overview_controls button",function(){var t=e(this).data("action");"attendance"===t?(e("#report_overview_responded").fadeIn(),e("#report_overview_responses").fadeOut()):"responses"===t&&(e("#report_overview_responses").fadeIn(),e("#report_overview_responded").fadeOut())})}},{key:"controls",get:function(){return e("#jazzquiz_controls_box")}},{key:"controlButtons",get:function(){return t.controls.find(".quiz-control-buttons")}},{key:"side",get:function(){return e("#jazzquiz_side_container")}},{key:"correctAnswer",get:function(){return e("#jazzquiz_correct_answer_container")}},{key:"isMerging",get:function(){return 0!==e(".merge-from").length}}]),t}();return{initialize:function(e,t,n){var o=new s(a);if(o.role.totalQuestions=e,t){a.addReportEventHandlers(),o.role.responses.showResponses=!0;var r=!0,i=!1,u=void 0;try{for(var l,c=n[Symbol.iterator]();!(r=(l=c.next()).done);r=!0){var d=l.value,h="jazzquiz_wrapper_responses_"+d.num,p="responses_wrapper_table_"+d.num,f="report_"+d.num;o.role.responses.set(h,p,d.responses,void 0,d.type,f,!1)}}catch(e){i=!0,u=e}finally{try{!r&&c.return&&c.return()}finally{if(i)throw u}}}else o.poll(500)}}});